<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºé¢å ±å‘Šç”¨ãƒ•ã‚©ãƒ¼ãƒ </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
</head>
<body>

    <form class="w-75 mx-auto">
        <p class="mt-3">æ—¥ä»˜</p>
        <div>
            <input class="form-control w-100 mt-1 datepicker" name="workDate" required>
        </div>
        <p class="mt-3">åå‰</p>
        <div>
            <input class="form-control w-100 mt-1" name="name" placeholder="" required>
        </div>
        <p class="mt-3">ã”è‡ªèº«ã®å‡ºå‘å†…å®¹</p>
        <div>
            <select class="form-control w-100 mt-1" name="assignmentDetails" required>
                <option value=""></option>
                <option value="å…¨æ—¥å‡ºå‘">å…¨æ—¥ğŸŒ•å‡ºå‘</option>
                <option value="åŠæ—¥å‡ºå‘">åŠæ—¥ğŸŒ“å‡ºå‘</option>
                <option value="å¤œé–“å‡ºå‘">å¤œé–“ğŸŒ™å‡ºå‘</option>
                <option value="å ±å‘Šã®ã¿">è‡ªåˆ†è‡ªèº«ã¯å‡ºå‘ã—ã¦ã„ãªã„ï¼ˆå ±å‘Šã®ã¿ï¼‰</option>
            </select>
        </div>
        <div id="siteNameContainer">
            <p class="mt-3">ç¾å ´å</p>
            <div>
                <input class="form-control w-100 mt-1" name="siteName" required>
            </div>
        </div>
        <p class="mt-3">ãã®ä»–</p>
        <div>
            <input class="form-control w-100 mt-1" name="notes" required>
        </div>
        <input type="submit" class="mt-4 btn btn-primary" value="é€ä¿¡">
    </form>
    
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // ***** LIFF ID *****
        const liffId = "2006480262-mQBgbR1d";
        initializeLiff(liffId);

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ ', err);
            });
        }

        function sendText(text) {
            liff.sendMessages([{
                'type': 'text',
                'text': text
            }]).then(function () {
                liff.closeWindow();
            }).catch(function (error) {
                window.alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ ' + error);
            });
        }

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—
        const params = (new URL(document.location)).searchParams;
        const key = params.get('key');

        // å‡ºå‘æ—¥ã®å…¥åŠ›ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¨­å®š
        $(document).ready(function () {
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤ºå½¢å¼ã‚’æ—¥æœ¬å½¢å¼ã«æŒ‡å®š
            $.datepicker.regional['ja'] = {
                closeText: 'é–‰ã˜ã‚‹',
                prevText: 'å‰æœˆ',
                nextText: 'æ¬¡æœˆ',
                currentText: 'ä»Šæ—¥',
                monthNames: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                monthNamesShort: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                dayNames: ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'],
                dayNamesShort: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                dayNamesMin: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                weekHeader: 'é€±',
                dateFormat: 'yy/mm/dd',
                firstDay: 0,
                isRTL: false,
                showMonthAfterYear: true,
                yearSuffix: ''
            };
            
            // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ—¥æœ¬ã«æŒ‡å®š
            $.datepicker.setDefaults($.datepicker.regional['ja']);
            
            // å¹´ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updateYearDisplay() {
                setTimeout(function() {
                    const currentYear = $('.ui-datepicker-year').text();
                    $('.ui-datepicker-year').replaceWith(`<span class="ui-datepicker-year">${currentYear}å¹´</span>`);
                }, 1);
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ï¼ˆãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã‚‚è¡¨ç¤ºã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®å‡¦ç†ï¼‰
            $(".datepicker").datepicker({
                changeMonth: true,     // æœˆã®å¤‰æ›´ã‚’æœ‰åŠ¹åŒ–
                changeYear: false,     // å¹´ã®å¤‰æ›´ã‚’ç„¡åŠ¹åŒ–
                showButtonPanel: true, // ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                beforeShow: function(input, inst) {
                    updateYearDisplay();
                },
                onChangeMonthYear: function(year, month, inst) {
                    updateYearDisplay();
                }
            });

            // å‡ºå‘å†…å®¹ ãŒå ±å‘Šã®ã¿ã®å ´åˆã® ç¾å ´å éè¡¨ç¤ºå‡¦ç†
            $('select[name="assignmentDetails"]').change(function() {
                const siteNameContainer = $('#siteNameContainer');
                const siteNameInput = $('input[name="siteName"]');
                
                if ($(this).val() === 'å ±å‘Šã®ã¿') {
                    siteNameContainer.hide();
                    siteNameInput.prop('required', false);
                } else {
                    siteNameContainer.show();
                    siteNameInput.prop('required', true);
                }
            });
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        $(function () {
            $('form').submit(function () {
                const workDate = $('input[name="workDate"]').val();
                const name = $('input[name="name"]').val();
                const assignmentDetails = $('select[name="assignmentDetails"]').val();
                const siteName = assignmentDetails === 'å ±å‘Šã®ã¿' ? '' : $('input[name="siteName"]').val();
                const notes = $('input[name="notes"]').val();
                
                const msg = `${workDate}\n${name}\n${assignmentDetails}\n${siteName}\n${notes}`;
                sendText(msg);

                return false;
            });
        });
        
    </script>

</body>
</html>